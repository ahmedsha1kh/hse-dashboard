<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HSE Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Your existing CSS */
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, sans-serif; background-color: #f3f4f6; color: #333; height: 100vh; overflow: hidden; }
    .container { display: flex; height: 100vh; }
    .sidebar {
      width: 220px; background-color: #ffffff; padding: 20px;
      display: flex; flex-direction: column; gap: 16px;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1); overflow-y: auto;
    }
    .sidebar h2 { font-size: 18px; margin-bottom: 8px; }
    .sidebar button {
      padding: 10px; font-size: 14px; background-color: #e5e7eb;
      border: none; border-radius: 5px; cursor: pointer;
      transition: background-color 0.2s;
    }
    .sidebar button:hover { background-color: #d1d5db; }
    .main { flex: 1; padding: 30px; overflow-y: auto; }
    .title { text-align: center; font-size: 32px; font-weight: bold; margin-bottom: 30px; }
    .chart-grid {
      display: grid; 
      /* Adjusted to fit 2 columns per row, with indicators potentially taking 1 */
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
      gap: 20px; margin-bottom: 40px;
    }
    .chart-box {
      background-color: #ffffff; padding: 20px; 
      border-radius: 10px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      height: 400px; /* Kept fixed height as in your original file */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    /* Styles for the dynamic indicators */
    .indicator-box {
      background-color: #ffffff; padding: 20px; border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      height: 300px; /* Adjust as needed */
    }
    .indicator-box h3 {
      font-size: 1.4em;
      margin-bottom: 15px;
      color: #333;
    }
    .completion-percentage {
      font-size: 3em;
      font-weight: bold;
      color: #28a745; /* Green color for positive completion */
      margin-bottom: 15px;
    }
    .completion-percentage.below-100 {
      color: #dc3545; /* Red color when below 100% */
    }
    .progress-bar-container {
      width: 80%;
      background-color: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      height: 20px;
      margin-top: 10px;
    }
    .progress-bar {
      height: 100%;
      background-color: #28a745; /* Green */
      width: 0%; /* Will be set by JS */
      border-radius: 10px;
      transition: width 0.5s ease-in-out, background-color 0.3s ease-in-out;
    }
    .progress-bar.below-100 {
      background-color: #dc3545; /* Red when below 100% */
    }
    .indicator-details {
      font-size: 0.9em;
      color: #666;
      margin-top: 10px;
    }
    /* Specific styling for the new environmental incidents indicator */
    #environmentalIncidentsIndicatorBox .incident-counts div {
        margin-top: 5px;
        font-size: 1.1em;
        color: #555;
    }
    #environmentalIncidentsIndicatorBox select {
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #ccc;
        margin-bottom: 15px; /* Space between dropdown and counts */
        width: 80%;
        max-width: 250px;
    }


    /* UPDATED/NEW MODAL CSS FOR BETTER FIT */
    .modal {
      display: none; justify-content: center; align-items: center;
      position: fixed; z-index: 1000; left: 0; top: 0;
      width: 100%; height: 100%; overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
      padding: 20px; box-sizing: border-box;
    }
    .modal.hidden { display: none; }
    .modal-content {
      background-color: white; padding: 30px; border-radius: 10px;
      width: 90%; max-width: 600px;
      max-height: calc(100vh - 40px); overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      position: relative;
      display: flex; flex-direction: column;
    }
    .modal .close {
      position: absolute; top: 10px; right: 16px;
      font-size: 24px; font-weight: bold; cursor: pointer; color: #aaa;
    }
    .modal .close:hover, .modal .close:focus {
      color: black; text-decoration: none;
    }

    /* Styles for the lists within modals (Edit/Delete selection) */
    .modal-list ul { list-style: none; padding: 0; margin: 0; }
    .modal-list li {
        padding: 10px 0; border-bottom: 1px solid #eee;
        display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;
    }
    .modal-list li:last-child { border-bottom: none; }
    .modal-list li span { flex-grow: 1; margin-right: 10px; word-break: break-all; }
    .modal-list li button {
        padding: 5px 10px; background-color: #007bff; color: white;
        border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; flex-shrink: 0;
    }
    .modal-list li button:hover { background-color: #0056b3; }

    /* Styles for generated form fields in create/edit modal */
    .modal-content form p { margin-bottom: 15px; }
    .modal-content form label { display: block; margin-bottom: 5px; font-weight: bold; }
    .modal-content form input[type="text"],
    .modal-content form input[type="number"],
    .modal-content form input[type="date"],
    .modal-content form input[type="email"],
    .modal-content form input[type="password"],
    .modal-content form textarea,
    .modal-content form select {
        width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
    }
    .modal-content form input[type="checkbox"] { margin-top: 5px; margin-right: 8px; }
    .modal-content form button[type="submit"] {
        background-color: #28a745; color: white; padding: 10px 20px;
        border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 15px;
        transition: background-color 0.2s; width: auto;
    }
    .modal-content form button[type="submit"]:hover { background-color: #218838; }

    /* Styles for read-only audit/user details in delete confirmation modal */
    .details-view div { margin-bottom: 10px; }
    .details-view label { font-weight: bold; display: block; margin-bottom: 5px; }
    .details-view span {
        display: block; padding: 8px; border: 1px solid #e9ecef;
        border-radius: 4px; background-color: #f8f9fa; word-wrap: break-word;
    }

    /* Delete Button Specific Style */
    #confirmDeleteButton, #confirmDeleteUserButton {
      background-color: #dc3545; margin-top: 20px; width: 100%;
      padding: 10px; font-size: 16px; border: none; border-radius: 5px;
      color: white; cursor: pointer; transition: background-color 0.2s;
    }
    #confirmDeleteButton:hover, #confirmDeleteUserButton:hover {
      background-color: #c82333;
    }

    /* Style for checkbox select multiple (groups) */
    .checkbox-select-multiple label {
        display: inline-block;
        margin-right: 15px;
        font-weight: normal;
    }
    .checkbox-select-multiple input[type="checkbox"] {
        margin-right: 5px;
    }
    .modal-content form ul.errorlist {
        color: red; list-style-type: none; padding: 0; margin-top: 5px; font-size: 0.9em;
    }

    /* Styles for audit type buttons */
    .audit-type-button {
      width: 100%;
      padding: 12px 20px;
      margin-bottom: 15px;
      font-size: 16px;
      font-weight: bold;
      color: #fff;
      background: linear-gradient(135deg, #4CAF50, #2E8B57);
      border: none;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      text-decoration: none;
      display: inline-block;
    }

    .audit-type-button:hover {
      background: linear-gradient(135deg, #2E8B57, #4CAF50);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }

    .audit-type-button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>
  <div class="container">

    <div class="sidebar">
      {% if is_authenticated %}
        <h2>Audits</h2>
        <button onclick="openModal('chooseAuditTypeModal')">Create Audit</button>
        <button onclick="openChooseEditAuditModal()">Edit Audit</button>
        <button onclick="openChooseDeleteAuditModal()">Delete Audit</button>
    
        {% if is_administrator %}
        <h2>Users</h2>
        <button onclick="openModal('createUserModal')">Create User</button>
        <button onclick="openChooseEditUserModal()">Edit User</button>
        <button onclick="openChooseDeleteUserModal()">Delete User</button>
        {% endif %}
      {% else %}
        <h2>Dashboard View</h2>
        <p>You are viewing as a guest.</p>
        <p>Login for full functionality.</p>
        <button onclick="window.location.href='{% url 'login' %}'">Login</button>
      {% endif %}
    </div>

    <div class="main">
      <div class="title">HSE Dashboard</div>
      <div class="chart-grid">
        <!-- FIRST CHART: Monthly Inspection Scores by Department -->
        <div class="chart-box" id="monthlyInspectionChartBox" style="grid-column: span 2;">
          <canvas id="monthlyInspectionScoresChart"></canvas>
        </div>
        <!-- Biannual NCRs by Lab Chart -->
        <div class="chart-box" id="biannualNCRChartBox" style="grid-column: span 2;">
          <canvas id="biannualNCRChart"></canvas>
        </div>

        <!-- HSE Inductions Completion Indicator -->
        <div class="indicator-box" id="hseInductionIndicatorBox">
          <h3>HSE Inductions Completion</h3>
          <div class="completion-percentage" id="hseInductionPercentage">0%</div>
          <div class="progress-bar-container">
            <div class="progress-bar" id="hseInductionProgressBar"></div>
          </div>
          <div class="indicator-details" id="hseInductionDetails"></div>
        </div>

        <!-- Annual Environmental Refresher Completion Indicator -->
        <div class="indicator-box" id="annualRefresherIndicatorBox">
          <h3>Annual Environmental Refresher Completion</h3>
          <div class="completion-percentage" id="annualRefresherPercentage">0%</div>
          <div class="progress-bar-container">
            <div class="progress-bar" id="annualRefresherProgressBar"></div>
          </div>
          <div class="indicator-details" id="annualRefresherDetails"></div>
        </div>


        {# NEW: Environmental Incidents Indicator Box #}
        <div class="indicator-box" id="environmentalIncidentsIndicatorBox" style="grid-column: span 2; height: 200px;">
            <h3>Environmental Incidents</h3>
            <select id="environmentalIncidentsLocationFilter" onchange="renderEnvironmentalIncidentsIndicator(this.value)">
                {# Options will be dynamically loaded by JS #}
            </select>
            <div class="incident-counts">
                <div id="incidentsPastMonth">Incidents (Past Month): 0</div>
                <div id="incidentsTotal">Total Incidents: 0</div>
            </div>
            {# No progress bar or percentage for this indicator, as per request #}
        </div>

      </div>
    </div>
  </div>

  <!-- Audit Modals -->
  <div id="chooseAuditTypeModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" onclick="closeModal('chooseAuditTypeModal')">&times;</span>
      <h2>Select Audit Type</h2>
      <button class="audit-type-button" onclick="switchModal('chooseAuditTypeModal', 'chemicalAuditModal')">Hazardous Waste Log</button><br><br>
      <button class="audit-type-button" onclick="switchModal('chooseAuditTypeModal', 'monthlyAuditModal')">Monthly Inspection</button><br><br>
      <button class="audit-type-button" onclick="switchModal('chooseAuditTypeModal', 'biannualAuditModal')">Biannual Environment Audit</button><br><br>
      <button class="audit-type-button" onclick="switchModal('chooseAuditTypeModal', 'hazardousAuditModal')">Hazardous Waste Inspection</button><br><br>
      <button class="audit-type-button" onclick="switchModal('chooseAuditTypeModal', 'annualRefresherModal')">Annual Environmental Refresher</button><br><br>
      <button class="audit-type-button" onclick="switchModal('chooseAuditTypeModal', 'hseInductionModal')">HSE Induction</button><br><br>
      <button class="audit-type-button" onclick="switchModal('chooseAuditTypeModal', 'environmentalIncidentModal')">Environmental Incidents</button> {# NEW BUTTON #}
    </div>
  </div>

  <div id="chemicalAuditModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" onclick="closeModal('chemicalAuditModal')">&times;</span>
      <h2>Hazardous Waste Log</h2>
      <form method="post" action="{% url 'create_chemical_audit' %}">
        {% csrf_token %}
        {{ chemical_form.as_p }}
        <button type="submit">Submit</button>
      </form>
    </div>
  </div>

  <div id="monthlyAuditModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" onclick="closeModal('monthlyAuditModal')">&times;</span>
      <h2>Monthly Inspection</h2>
      <form method="post" action="{% url 'create_monthly_audit' %}">
        {% csrf_token %}
        {{ monthly_form.as_p }}
        <button type="submit">Submit</button>
      </form>
    </div>
  </div>


  <div id="biannualAuditModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" onclick="closeModal('biannualAuditModal')">&times;</span>
      <h2>Biannual Environment Audit</h2>
      <form method="post" action="{% url 'create_biannual_audit' %}">
        {% csrf_token %}
        {{ biannual_form.as_p }}
        <button type="submit">Submit</button>
      </form>
    </div>
  </div>

  <div id="hazardousAuditModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" onclick="closeModal('hazardousAuditModal')">&times;</span>
      <h2>Hazardous Waste Inspection</h2>
      <form method="post" action="{% url 'create_hazardous_audit' %}">
        {% csrf_token %}
        {{ hazardous_form.as_p }}
        <button type="submit">Submit</button>
      </form>
    </div>
  </div>

  {# NEW: Annual Environmental Refresher Modal #}
  <div id="annualRefresherModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" onclick="closeModal('annualRefresherModal')">&times;</span>
      <h2>Annual Environmental Refresher</h2>
      <form method="post" action="{% url 'create_annual_refresher_audit' %}">
        {% csrf_token %}
        {{ annual_refresher_form.as_p }}
        <button type="submit">Submit</button>
      </form>
    </div>
  </div>

  {# NEW: HSE Induction Modal #}
  <div id="hseInductionModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" onclick="closeModal('hseInductionModal')">&times;</span>
      <h2>HSE Induction</h2>
      <form method="post" action="{% url 'create_hse_induction_audit' %}">
        {% csrf_token %}
        {{ hse_induction_form.as_p }}
        <button type="submit">Submit</button>
      </form>
    </div>
  </div>

  {# NEW: Environmental Incidents Modal #}
  <div id="environmentalIncidentModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" onclick="closeModal('environmentalIncidentModal')">&times;</span>
      <h2>Environmental Incidents</h2>
      <form method="post" action="{% url 'create_environmental_incident_audit' %}"> {# NEW URL #}
        {% csrf_token %}
        {{ environmental_incident_form.as_p }} {# NEW FORM INSTANCE #}
        <button type="submit">Submit</button>
      </form>
    </div>
  </div>


  <div id="chooseEditAuditModal" class="modal hidden">
    <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
      <span class="close" onclick="closeModal('chooseEditAuditModal')">&times;</span>
      <h2>Select Audit to Edit</h2>
      <div id="editAuditListContainer" class="modal-list">
        <ul>
            {# Audits will be loaded dynamically by JavaScript #}
            {# The Django for loop below is good for initial render if audits are passed, but dynamic loading is better for responsiveness #}
            {# Removed direct {% for audit in audits %} as JS fetches dynamically now #}
        </ul>
      </div>
    </div>
  </div>

  <div id="editAuditFormModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" onclick="closeModal('editAuditFormModal')">&times;</span>
      <h2 id="editAuditModalTitle">Edit Audit</h2>
      <form id="editAuditForm" method="post">
        {% csrf_token %}
        <div id="editAuditFormFields"></div>
        <button type="submit">Save Changes</button>
      </form>
    </div>
  </div>

  <div id="chooseDeleteAuditModal" class="modal hidden">
    <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
      <span class="close" onclick="closeModal('chooseDeleteAuditModal')">&times;</span>
      <h2>Select Audit to Delete</h2>
      <div id="deleteAuditListContainer" class="modal-list">
          <ul>
              {# Audits will be loaded dynamically by JavaScript #}
        </ul>
      </div>
    </div>
  </div>

  <div id="deleteConfirmationModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" onclick="closeModal('deleteConfirmationModal')">&times;</span>
      <h2 id="deleteAuditModalTitle">Confirm Delete Audit</h2>
      <div id="deleteAuditDetailsContainer" class="details-view">
        <!-- Audit details will be loaded here (read-only) -->
      </div>
      <button id="confirmDeleteButton" class="delete-button" data-audit-id="">Confirm Delete</button>
    </div>
  </div>


  <!-- ************************************************************* -->
  <!-- USER MANAGEMENT MODALS -->
  <!-- ************************************************************* -->

  {# Only include user management modals if the user is authenticated #}
  {% if is_authenticated %}
  <div id="createUserModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" onclick="closeModal('createUserModal')">&times;</span>
      <h2>Create New User</h2>
      <form id="createUserForm" method="post" action="{% url 'create_user' %}">
        {% csrf_token %}
        {{ user_creation_form.as_p }}
        <button type="submit">Create User</button>
      </form>
    </div>
  </div>

  <div id="chooseEditUserModal" class="modal hidden">
    <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
      <span class="close" onclick="closeModal('chooseEditUserModal')">&times;</span>
      <h2>Select User to Edit</h2>
      <div id="editUserListContainer" class="modal-list">
        <ul>
          <!-- Users will be loaded here dynamically -->
        </ul>
      </div>
    </div>
  </div>

  <div id="editUserFormModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" onclick="closeModal('editUserFormModal')">&times;</span>
      <h2 id="editUserModalTitle">Edit User</h2>
      <form id="editUserForm" method="post">
        {% csrf_token %}
        <div id="editUserFormFields">
          <!-- User form fields loaded dynamically -->
        </div>
        <button type="submit">Save Changes</button>
      </form>
    </div>
  </div>

  <div id="chooseDeleteUserModal" class="modal hidden">
    <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
      <span class="close" onclick="closeModal('chooseDeleteUserModal')">&times;</span>
      <h2>Select User to Delete</h2>
      <div id="deleteUserListContainer" class="modal-list">
        <ul>
          <!-- Users will be loaded here dynamically -->
        </ul>
      </div>
    </div>
  </div>

  <div id="deleteUserConfirmationModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" onclick="closeModal('deleteUserConfirmationModal')">&times;</span>
      <h2 id="deleteUserModalTitle">Confirm Delete User</h2>
      <div id="deleteUserDetailsContainer" class="details-view">
        <!-- User details will be loaded here (read-only) -->
      </div>
      <button id="confirmDeleteUserButton" class="delete-button" data-user-id="">Confirm Delete</button>
    </div>
  </div>
  {% endif %} {# End if is_authenticated for user modals #}


  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
  <script>
    // Helper to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // General Modal Functions
    function openModal(modalId) {
        document.getElementById(modalId).classList.remove('hidden');
        document.getElementById(modalId).style.display = 'flex';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
        document.getElementById(modalId).style.display = 'none';
    }

    function switchModal(closeModalId, openModalId) {
        closeModal(closeModalId);
        openModal(openModalId);
    }

    // Helper to create form fields for editing (used for both Audits and Users)
    function createFormFieldHtml(fieldName, value, fieldType, options = []) {
        const label = fieldName.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase());
        let inputHtml = '';
        const id = `id_${fieldName}`;

        if (fieldType === 'boolean') {
            const isChecked = value === true || value === 'true';
            inputHtml = `<input type="checkbox" id="${id}" name="${fieldName}" ${isChecked ? 'checked' : ''}>`;
        } else if (fieldType === 'date') {
            inputHtml = `<input type="date" id="${id}" name="${fieldName}" value="${value || ''}">`;
        } else if (fieldType === 'textarea') {
             inputHtml = `<textarea id="${id}" name="${fieldName}" rows="4">${value || ''}</textarea>`;
        } else if (fieldType === 'number') {
            inputHtml = `<input type="number" id="${id}" name="${fieldName}" value="${value || ''}">`;
        } else if (fieldType === 'select') {
            let optionHtml = options.map(option => `<option value="${option.value}" ${value === option.value ? 'selected' : ''}>${option.text}</option>`).join('');
            inputHtml = `<select id="${id}" name="${fieldName}">${optionHtml}</select>`;
        } else if (fieldType === 'multiselect-checkbox') {
            let checkboxHtml = options.map(option => `
                <label>
                    <input type="checkbox" name="${fieldName}" value="${option.value}" ${value && value.includes(option.value) ? 'checked' : ''}>
                    ${option.text}
                </label>
            `).join('<br>');
            inputHtml = `<div class="checkbox-select-multiple">${checkboxHtml}</div>`;
        } else if (fieldType === 'password') {
            inputHtml = `<input type="password" id="${id}" name="${fieldName}" value="">`;
        } else if (fieldName === 'score') {
            inputHtml = `<input type="text" id="${id}" name="${fieldName}" value="${value !== null ? value + '%' : 'N/A'}" readonly>`;
        }
        else {
            inputHtml = `<input type="text" id="${id}" name="${fieldName}" value="${value || ''}">`;
        }
        return `
            <p>
                <label for="${id}">${label}:</label>
                ${inputHtml}
            </p>
        `;
    }

    // Helper for displaying read-only details (used for both Audits and Users)
    function createDisplayFieldHtml(fieldName, value) {
        const label = fieldName.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase());
        let displayValue = value;
        if (typeof value === 'boolean' || value === 'true' || value === 'false') {
            displayValue = (value === true || value === 'true') ? 'Yes' : 'No';
        } else if (value === null || value === undefined || value === '') {
            displayValue = 'N/A';
        } else if (Array.isArray(value)) {
            displayValue = value.join(', ');
        } else if (fieldName === 'score' && value !== null) {
            displayValue = value + '%';
        }
        // Handle numerical fields for Biannual, Annual Refresher, HSE Induction, Chemical Waste, Environmental Incidents
        else if (['number_of_nonconformances', 'number_of_closeouts', 'number_of_employees', 'number_of_employees_trained', 'number_of_inductions', 'quantity_liters', 'number_of_incidents'].includes(fieldName) && value !== null) {
            displayValue = value;
            if (fieldName === 'quantity_liters') {
                displayValue += ' L';
            }
        }
        // Handle text area fields like 'description' and 'details'
        else if (['description', 'details'].includes(fieldName) && value !== null) {
            displayValue = value;
        }

        return `
            <div>
                <label>${label}:</label>
                <span>${displayValue}</span>
            </div>
        `;
    }


    // --- Audit Functions ---
    // Only add event listeners if the user is authenticated, otherwise these elements/forms aren't present
    {% if is_authenticated %}
    document.querySelectorAll('form[action^="/audits/create_"]').forEach(form => {
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(form);
            fetch(form.action, {
                method: 'POST', body: formData, headers: { 'X-CSRFToken': csrftoken },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') { alert(data.message); closeModal(form.closest('.modal').id); window.location.reload(); }
                else { alert('Error: ' + JSON.stringify(data.errors || data.message)); }
            })
            .catch(error => { console.error('Error:', error); alert('An error occurred during submission.'); });
        });
    });

    document.getElementById('editAuditForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        fetch(form.action, {
            method: 'POST', body: formData, headers: { 'X-CSRFToken': csrftoken },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') { alert(data.message); closeModal('editAuditFormModal'); window.location.reload(); }
            else { alert('Error: ' + JSON.stringify(data.errors || data.message)); }
            // Re-render all dynamic elements after an edit
            renderAllDashboardElements();
        })
        .catch(error => { console.error('Error:', error); alert('An error occurred while saving changes.'); });
    });

    function loadAuditData(auditId) {
        fetch(`/audits/get-audit/${auditId}/`)
            .then(response => { if (!response.ok) { console.error('Failed to fetch audit data:', response.status, response.statusText); alert('Failed to load audit data for edit. Please try again.'); throw new Error(`HTTP error! status: ${response.status}`); } return response.json(); })
            .then(data => {
                console.log("\n--- FRONTEND: RECEIVED AUDIT DATA (EDIT) ---", data);

                const form = document.getElementById('editAuditForm');
                const formFieldsContainer = document.getElementById('editAuditFormFields');
                const modalTitle = document.getElementById('editAuditModalTitle');

                form.action = `/audits/edit-audit/${data.id}/`;
                formFieldsContainer.innerHTML = '';

                modalTitle.textContent = `Edit ${data.display_audit_type} Audit`;

                // Define all possible location choices for the select dropdown
                const locationOptions = [
                    { value: '', text: 'Select Location' },
                    { value: 'KBD Fisheries Lab', text: 'KBD Fisheries Lab' }, { value: 'KBD Algae Lab', text: 'KBD Algae Lab' },
                    { value: 'KBD Aquaculture Lab', text: 'KBD Aquaculture Lab' }, { value: 'KBD Algae Facility Laboratory', text: 'KBD Algae Facility Laboratory' },
                    { value: 'Duba Lab', text: 'Duba Lab' }, { value: 'Jizan Lab', text: 'Jizan Lab' },
                    { value: 'Jubail Lab', text: 'Jubail Lab' }, { value: 'Al Raes Sea Cage Farms', text: 'Al Raes Sea Cage Farms' },
                    { value: 'Algae Facility Phase 2', text: 'Algae Facility Phase 2' },
                ];


                for (const [key, value] of Object.entries(data)) {
                    if (key === 'id' || key === 'csrfmiddlewaretoken' || key === 'display_audit_type') { continue; }
                    if (key === 'audit_type' || key === 'AuditID') {
                        formFieldsContainer.innerHTML += `<div><label>${key.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase())}:</label><span>${value}</span></div>`;
                        continue;
                    }

                    let fieldType = 'text';
                    if (typeof value === 'boolean') { fieldType = 'boolean'; }
                    else if (['score', 'number_of_nonconformances', 'quantity_liters', 'number_of_closeouts', 'number_of_employees', 'number_of_employees_trained', 'number_of_inductions', 'number_of_incidents'].includes(key)) { // ADDED number_of_incidents
                        fieldType = 'number';
                    }
                    else if (key.includes('date')) { fieldType = 'date'; }
                    else if (['comment', 'description', 'details'].includes(key)) { fieldType = 'textarea'; } // ADDED details
                    else if (key === 'location') {
                        fieldType = 'select';
                        formFieldsContainer.innerHTML += createFormFieldHtml(key, value, fieldType, locationOptions);
                        continue;
                    }

                    formFieldsContainer.innerHTML += createFormFieldHtml(key, value, fieldType);
                }
                closeModal('chooseEditAuditModal'); openModal('editAuditFormModal');
            })
            .catch(error => { console.error('Error loading audit data for edit:', error); alert('Failed to load audit data for edit. Please try again.'); });
    }

    function openChooseEditAuditModal() {
        fetch('/audits/get-all-audits/')
            .then(response => response.json())
            .then(audits => {
                const editAuditListContainer = document.getElementById('editAuditListContainer').querySelector('ul');
                editAuditListContainer.innerHTML = '';
                if (audits.length === 0) { editAuditListContainer.innerHTML = '<li>No audits available to edit.</li>'; return; }
                audits.forEach(audit => {
                    const listItem = document.createElement('li'); listItem.setAttribute('ondblclick', `loadAuditData(${audit.id})`);
                    let displayInfo = '';
                    if (audit.audit_type === 'monthly' && audit.score !== null) {
                        displayInfo = ` — Score: ${audit.score}%`;
                    } else if (audit.audit_type === 'biannual' && audit.number_of_nonconformances !== null && audit.number_of_closeouts !== null) {
                        const openNCRs = audit.number_of_nonconformances - audit.number_of_closeouts;
                        displayInfo = ` — NCRs: ${audit.number_of_nonconformances} (Open: ${openNCRs})`;
                    } else if (audit.audit_type === 'annual_refresher' && audit.number_of_employees !== null && audit.number_of_employees_trained !== null) {
                        displayInfo = ` — Total Employees: ${audit.number_of_employees}, Trained: ${audit.number_of_employees_trained}`;
                    } else if (audit.audit_type === 'hse_induction' && audit.number_of_inductions !== null) {
                        displayInfo = ` — Inductions: ${audit.number_of_inductions}`;
                    } else if ((audit.audit_type === 'chemical_waste' || audit.audit_type === 'hazardous') && audit.quantity_liters !== null) {
                         displayInfo = ` — Quantity: ${audit.quantity_liters}L`;
                    } else if (audit.audit_type === 'environmental_incidents' && audit.number_of_incidents !== null) { // NEW DISPLAY INFO
                         displayInfo = ` — Incidents: ${audit.number_of_incidents}`;
                    }


                    listItem.innerHTML = `<span>${audit.AuditID || 'N/A'} &mdash; ${audit.display_audit_type || 'N/A'} on ${audit.date || 'N/A'}${displayInfo}</span><button type="button" onclick="loadAuditData(${audit.id})">Select</button>`;
                    editAuditListContainer.appendChild(listItem);
                });
                openModal('chooseEditAuditModal');
            })
            .catch(error => { console.error('Error fetching audits for edit list:', error); alert('Failed to load audit list for editing.'); });
    }

    function openChooseDeleteAuditModal() {
        fetch('/audits/get-all-audits/')
            .then(response => response.json())
            .then(audits => {
                const deleteAuditListContainer = document.getElementById('deleteAuditListContainer').querySelector('ul');
                deleteAuditListContainer.innerHTML = '';
                if (audits.length === 0) { deleteAuditListContainer.innerHTML = '<li>No audits available to delete.</li>'; return; }
                audits.forEach(audit => {
                    const listItem = document.createElement('li'); listItem.setAttribute('ondblclick', `loadAuditDataForDeleteConfirmation(${audit.id})`);
                    let displayInfo = '';
                    if (audit.audit_type === 'monthly' && audit.score !== null) {
                        displayInfo = ` — Score: ${audit.score}%`;
                    } else if (audit.audit_type === 'biannual' && audit.number_of_nonconformances !== null && audit.number_of_closeouts !== null) {
                        const openNCRs = audit.number_of_nonconformances - audit.number_of_closeouts;
                        displayInfo = ` — NCRs: ${audit.number_of_nonconformances} (Open: ${openNCRs})`;
                    } else if (audit.audit_type === 'annual_refresher' && audit.number_of_employees !== null && audit.number_of_employees_trained !== null) {
                        displayInfo = ` — Total Employees: ${audit.number_of_employees}, Trained: ${audit.number_of_employees_trained}`;
                    } else if (audit.audit_type === 'hse_induction' && audit.number_of_inductions !== null) {
                        displayInfo = ` — Inductions: ${audit.number_of_inductions}`;
                    } else if ((audit.audit_type === 'chemical_waste' || audit.audit_type === 'hazardous') && audit.quantity_liters !== null) {
                         displayInfo = ` — Quantity: ${audit.quantity_liters}L`;
                    } else if (audit.audit_type === 'environmental_incidents' && audit.number_of_incidents !== null) { // NEW DISPLAY INFO
                         displayInfo = ` — Incidents: ${audit.number_of_incidents}`;
                    }

                    listItem.innerHTML = `<span>${audit.AuditID || 'N/A'} &mdash; ${audit.display_audit_type || 'N/A'} on ${audit.date || 'N/A'}${displayInfo}</span><button type="button" onclick="loadAuditDataForDeleteConfirmation(${audit.id})">Select</button>`;
                    deleteAuditListContainer.appendChild(listItem);
                });
                openModal('chooseDeleteAuditModal');
            })
            .catch(error => { console.error('Error fetching audits for delete list:', error); alert('Failed to load audit list for deletion.'); });
    }

    function loadAuditDataForDeleteConfirmation(auditId) {
        fetch(`/audits/get-audit/${auditId}/`)
            .then(response => { if (!response.ok) { console.error('Failed to fetch audit data:', response.status, response.statusText); alert('Failed to load audit data for deletion. Please try again.'); throw new Error(`HTTP error! status: ${response.status}`); } return response.json(); })
            .then(data => {
                console.log("\n--- FRONTEND: RECEIVED AUDIT DATA (DELETE) ---", data);

                const deleteAuditDetailsContainer = document.getElementById('deleteAuditDetailsContainer');
                const modalTitle = document.getElementById('deleteAuditModalTitle');
                const confirmDeleteButton = document.getElementById('confirmDeleteButton');

                deleteAuditDetailsContainer.innerHTML = '';
                modalTitle.textContent = `Confirm Delete ${data.display_audit_type} Audit`;

                for (const [key, value] of Object.entries(data)) {
                    if (key === 'id' || key === 'csrfmiddlewaretoken' || key === 'audit_type' || key === 'display_audit_type') { continue; }
                    deleteAuditDetailsContainer.innerHTML += createDisplayFieldHtml(key, value);
                }
                confirmDeleteButton.dataset.auditId = data.id;
                closeModal('chooseDeleteAuditModal'); openModal('deleteConfirmationModal');
            })
            .catch(error => { console.error('Error loading audit data for delete confirmation:', error); alert('Failed to load audit data for deletion confirmation. Please try again.'); });
    }

    document.getElementById('confirmDeleteButton').addEventListener('click', function() {
        const auditIdToDelete = this.dataset.auditId;
        if (!auditIdToDelete) { alert('No audit selected for deletion.'); return; }
        if (!confirm('Are you absolutely sure you want to delete this audit? This action cannot be undone.')) { return; }

        fetch(`/audits/delete-audit/${auditIdToDelete}/`, {
            method: 'POST', headers: { 'X-CSRFToken': csrftoken },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message); closeModal('deleteConfirmationModal'); window.location.reload();
                renderAllDashboardElements(); // Re-render all elements
            } else {
                alert('Error: ' + (data.message || 'An unknown error occurred during deletion.'));
            }
        })
        .catch(error => { console.error('Error during deletion:', error); alert('An error occurred while trying to delete the audit.'); });
    });
    {% endif %} {# End if is_authenticated for audit functions #}


    // --- User Management Functions (Existing) ---
    {% if is_authenticated %}
    document.getElementById('createUserForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        const groupCheckboxes = form.querySelectorAll('input[name="groups"]:checked');
        const selectedGroupIds = Array.from(groupCheckboxes).map(cb => cb.value);
        formData.delete('groups');
        selectedGroupIds.forEach(id => formData.append('groups', id));

        fetch(form.action, {
            method: 'POST', body: formData, headers: { 'X-CSRFToken': csrftoken },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message); closeModal('createUserModal'); window.location.reload();
            } else {
                let errorMessages = 'Error: ';
                if (data.errors) {
                    for (const field in data.errors) {
                        if (field === '__all__') {
                            errorMessages += `\nGeneral: ${data.errors[field].join('; ')}`;
                        } else {
                            errorMessages += `\n${field}: ${data.errors[field].join('; ')}`;
                        }
                    }
                } else if (data.message) { errorMessages += data.message; }
                alert(errorMessages);
            }
        })
        .catch(error => { console.error('Error creating user:', error); alert('An error occurred during user creation.'); });
    });

    function openChooseEditUserModal() {
        fetch('/audits/users/all/')
            .then(response => response.json())
            .then(users => {
                const deleteUserListContainer = document.getElementById('editUserListContainer').querySelector('ul');
                deleteUserListContainer.innerHTML = '';
                if (users.length === 0) { return; }
                users.forEach(user => {
                    const listItem = document.createElement('li'); listItem.setAttribute('ondblclick', `loadUserDataForEdit(${user.id})`);
                    const groupDisplay = user.groups && user.groups.length > 0 ? ` (${user.groups.join(', ')})` : '';
                    listItem.innerHTML = `<span>${user.username}${groupDisplay}</span><button type="button" onclick="loadUserDataForEdit(${user.id})">Select</button>`;
                    deleteUserListContainer.appendChild(listItem);
                });
                openModal('chooseEditUserModal');
            })
            .catch(error => { console.error('Error fetching users for edit list:', error); alert('Failed to load user list for editing.'); });
    }

    async function loadUserDataForEdit(userId) {
        try {
            const userResponse = await fetch(`/audits/users/${userId}/`);
            if (!userResponse.ok) { throw new Error(`HTTP error! status: ${userResponse.status}`); }
            const userData = await userResponse.json();
            console.log("\n--- FRONTEND: RECEIVED USER DATA (EDIT) ---", userData);

            const groupsResponse = await fetch('/audits/users/all_groups/');
            if (!groupsResponse.ok) { throw new Error(`HTTP error! status: ${groupsResponse.status}`); }
            const allGroups = await groupsResponse.json(); 
            const groupOptions = allGroups.map(group => ({ value: group.id.toString(), text: group.name }));

            const form = document.getElementById('editUserForm');
            const formFieldsContainer = document.getElementById('editUserFormFields');
            const modalTitle = document.getElementById('editUserModalTitle');

            form.action = `/audits/users/${userData.id}/edit/`;
            formFieldsContainer.innerHTML = '';
            modalTitle.textContent = `Edit User: ${userData.username}`;

            const fieldsToRender = ['username', 'first_name', 'last_name', 'groups'];

            for (const fieldName of fieldsToRender) {
                if (fieldName === 'groups') {
                    formFieldsContainer.innerHTML += createFormFieldHtml(fieldName, userData.selected_group_ids, 'multiselect-checkbox', groupOptions);
                } else {
                    formFieldsContainer.innerHTML += createFormFieldHtml(fieldName, userData[fieldName], 'text');
                }
            }
            closeModal('chooseEditUserModal'); openModal('editUserFormModal');

        } catch (error) { console.error('Error loading user data for edit:', error); alert('Failed to load user data for edit. Please try again.'); }
    }

    document.getElementById('editUserForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        const groupCheckboxes = form.querySelectorAll('input[name="groups"]:checked');
        const selectedGroupIds = Array.from(groupCheckboxes).map(cb => cb.value);
        formData.delete('groups');
        selectedGroupIds.forEach(id => formData.append('groups', id));

        fetch(form.action, {
            method: 'POST', body: formData, headers: { 'X-CSRFToken': csrftoken },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message); closeModal('editUserFormModal'); window.location.reload();
            } else {
                let errorMessages = 'Error: ';
                if (data.errors) {
                    for (const field in data.errors) {
                        if (field === '__all__') {
                            errorMessages += `\nGeneral: ${data.errors[field].join('; ')}`;
                        } else {
                            errorMessages += `\n${field}: ${data.errors[field].join('; ')}`;
                        }
                    }
                } else if (data.message) { errorMessages += data.message; }
                alert(errorMessages);
            }
        })
        .catch(error => { console.error('Error editing user:', error); alert('An error occurred during user editing.'); });
    });


    function openChooseDeleteUserModal() {
        fetch('/audits/users/all/')
            .then(response => response.json())
            .then(users => {
                const deleteUserListContainer = document.getElementById('deleteUserListContainer').querySelector('ul');
                deleteUserListContainer.innerHTML = '';
                if (users.length === 0) { return; }
                users.forEach(user => {
                    const listItem = document.createElement('li'); listItem.setAttribute('ondblclick', `loadUserDataForDeleteConfirmation(${user.id})`);
                    const groupDisplay = user.groups && user.groups.length > 0 ? ` (${user.groups.join(', ')})` : '';
                    listItem.innerHTML = `<span>${user.username}${groupDisplay}</span><button type="button" onclick="loadUserDataForDeleteConfirmation(${user.id})">Select</button>`;
                    deleteUserListContainer.appendChild(listItem);
                });
                openModal('chooseDeleteUserModal');
            })
            .catch(error => { console.error('Error fetching users for delete list:', error); alert('Failed to load user list for deletion.'); });
    }

    async function loadUserDataForDeleteConfirmation(userId) {
        try {
            const response = await fetch(`/audits/users/${userId}/`);
            if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
            const data = await response.json();
            console.log("\n--- FRONTEND: RECEIVED USER DATA (DELETE) ---", data);

            const deleteUserDetailsContainer = document.getElementById('deleteUserDetailsContainer');
            const modalTitle = document.getElementById('deleteUserModalTitle');
            const confirmDeleteUserButton = document.getElementById('confirmDeleteUserButton');

            deleteUserDetailsContainer.innerHTML = '';
            modalTitle.textContent = `Confirm Delete User: ${data.username}`;

            const fieldsToDisplay = ['username', 'first_name', 'last_name', 'groups', 'is_active', 'date_joined'];
            for (const fieldName of fieldsToDisplay) {
                deleteUserDetailsContainer.innerHTML += createDisplayFieldHtml(fieldName, data[fieldName]);
            }

            confirmDeleteUserButton.dataset.userId = data.id;
            closeModal('chooseDeleteUserModal'); openModal('deleteUserConfirmationModal');

        } catch (error) { console.error('Error loading user data for delete confirmation:', error); alert('Failed to load user data for deletion confirmation. Please try again.'); }
    }

    document.getElementById('confirmDeleteUserButton').addEventListener('click', function() {
        const userIdToDelete = this.dataset.userId;
        if (!userIdToDelete) { alert('No user selected for deletion.'); return; }
        if (!confirm('Are you absolutely sure you want to delete this user? This action cannot be undone.')) { return; }

        fetch(`/audits/users/${userIdToDelete}/delete/`, {
            method: 'POST', headers: { 'X-CSRFToken': csrftoken },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message); closeModal('deleteUserConfirmationModal'); window.location.reload();
            } else {
                alert('Error: ' + (data.message || 'An unknown error occurred during deletion.'));
            }
        })
        .catch(error => { console.error('Error during user deletion:', error); alert('An error occurred while trying to delete the user.'); });
    });
    {% endif %} {# End if is_authenticated for user functions #}


    // Charting Logic
    console.log("DOMContentLoaded listener being added.");
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOMContentLoaded fired.");

        if (typeof ChartjsAnnotation !== 'undefined') {
            console.log("ChartjsAnnotation found, registering plugin.");
            Chart.register(ChartjsAnnotation);
        } else {
            console.warn("ChartjsAnnotation plugin not found. Target line might not render.");
        }
        
        // Initial render of all dashboard elements
        renderAllDashboardElements();
    });

    // Centralized function to render all dashboard elements
    function renderAllDashboardElements() {
        console.log("Calling renderMonthlyInspectionScoresChart().");
        renderMonthlyInspectionScoresChart();
        console.log("renderMonthlyInspectionScoresChart() called.");

        console.log("Calling renderBiannualNCRChart().");
        renderBiannualNCRChart();
        console.log("renderBiannualNCRChart() called.");

        console.log("Calling renderHSEInductionCompletion().");
        renderHSEInductionCompletion();
        console.log("renderHSEInductionCompletion() called.");

        console.log("Calling renderAnnualRefresherCompletion().");
        renderAnnualRefresherCompletion();
        console.log("renderAnnualRefresherCompletion() called.");

        console.log("Calling renderWasteQuantityPerLabChart().");
        renderWasteQuantityPerLabChart();
        console.log("renderWasteQuantityPerLabChart() called.");

        console.log("Calling renderEnvironmentalIncidentsIndicator().");
        renderEnvironmentalIncidentsIndicator(); // NEW CALL
        console.log("renderEnvironmentalIncidentsIndicator() called.");
    }

    let monthlyInspectionChartInstance = null;
    let biannualNCRChartInstance = null;
    let wasteQuantityChartInstance = null;

    // Helper to add/clear error messages for chart boxes and indicator boxes
    function setChartError(elementId, errorMessage, title = "") {
        const elementBox = document.getElementById(elementId);
        if (elementBox) {
            // Remove any existing error messages
            let existingError = elementBox.querySelector('.error-message'); // Changed class for more generic use
            if (existingError) {
                existingError.remove();
            }

            if (errorMessage) {
                // Ensure the title is present, or re-add it if removed by a previous error
                if (title && !elementBox.querySelector('h3')) {
                     elementBox.insertAdjacentHTML('afterbegin', `<h3>${title}</h3>`);
                }
                const errorDiv = document.createElement('p');
                errorDiv.className = 'error-message'; // Generic error class
                errorDiv.style.color = 'red';
                errorDiv.style.textAlign = 'center';
                errorDiv.style.marginTop = '10px';
                errorDiv.textContent = errorMessage;
                elementBox.appendChild(errorDiv);
            }
        }
    }

    // Generic chart creation helper
    async function createChart(canvasId, fetchUrl, chartOptionsFunc, chartTitle, chartInstanceRefWrapper) {
        const canvas = document.getElementById(canvasId);
        const chartBox = canvas ? canvas.closest('.chart-box') : null;

        if (!canvas || !chartBox) {
            console.error(`Canvas or chart box not found for ID: ${canvasId}`);
            if (chartBox && !canvas) {
                const originalHtml = `<h3>${chartTitle}</h3><canvas id="${canvasId}"></canvas>`;
                chartBox.innerHTML = originalHtml;
                const newCanvas = document.getElementById(canvasId);
                if (newCanvas) {
                    return createChart(canvasId, fetchUrl, chartOptionsFunc, chartTitle, chartInstanceRefWrapper);
                }
            }
            setChartError(chartBox ? chartBox.id : canvasId, `Chart initialization failed: Missing elements.`, chartTitle);
            return null;
        }

        try {
            setChartError(chartBox.id, ""); 
            console.log(`Fetching data for ${canvasId} from ${fetchUrl}`);
            const response = await fetch(fetchUrl);
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`HTTP Error for ${canvasId}: ${response.status} ${response.statusText}`, errorText);
                setChartError(chartBox.id, `Error loading data: ${response.status} ${response.statusText}.`, chartTitle);
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const chartData = await response.json();
            console.log(`Data for ${canvasId} received:`, chartData);

            if (chartInstanceRefWrapper.instance) {
                chartInstanceRefWrapper.instance.destroy();
                chartInstanceRefWrapper.instance = null;
                console.log(`Destroyed existing chart instance for ${canvasId}.`);
            }

            const chartCtx = canvas.getContext('2d');
            chartInstanceRefWrapper.instance = new Chart(chartCtx, chartOptionsFunc(chartData));
            console.log(`${canvasId} rendered successfully.`);
            return chartInstanceRefWrapper.instance;

        } catch (error) {
            console.error(`Error rendering ${canvasId} chart:`, error);
            if (chartBox && !chartBox.querySelector('.error-message')) {
                setChartError(chartBox.id, `Failed to load chart data.`, chartTitle);
            }
            return null;
        }
    }


    async function renderMonthlyInspectionScoresChart() {
        // Pass a wrapper object for the instance so it can be updated by createChart
        monthlyInspectionChartInstance = await createChart(
            'monthlyInspectionScoresChart',
            '/audits/charts/monthly_inspection_scores/',
            (chartData) => ({
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: `Last Year Average`,
                            data: chartData.lastYearAverageScores,
                            backgroundColor: 'rgba(153, 102, 255, 0.8)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1,
                            borderRadius: 5,
                        },
                        {
                            label: `${chartData.currentMonthName} Scores`,
                            data: chartData.currentMonthScores,
                            backgroundColor: 'rgba(75, 192, 192, 0.8)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            borderRadius: 5,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Monthly Inspection Scores: Current Month vs. Last Year Average',
                            font: { size: 18 }
                        },
                        legend: { position: 'top', labels: { boxWidth: 20, padding: 15 } },
                        annotation: {
                            annotations: {
                                targetLine: {
                                    type: 'line', yMin: chartData.target, yMax: chartData.target,
                                    borderColor: 'rgba(255, 0, 0, 0.8)', borderWidth: 2, borderDash: [5, 5],
                                    label: {
                                        display: true, content: 'Target (100%)', position: 'end',
                                        backgroundColor: 'rgba(255, 0, 0, 0.8)', color: '#fff',
                                        font: { size: 10, weight: 'bold' }, padding: 6, borderRadius: 4
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Departments' }, grid: { display: false } },
                        y: { beginAtZero: true, max: 100, title: { display: true, text: 'Score (%)' }, ticks: { callback: function(value) { return value + '%'; } } }
                    },
                    barPercentage: 0.8, categoryPercentage: 0.7,
                }
            }),
            'Monthly Inspection Scores: Current Month vs. Last Year Average',
            { instance: monthlyInspectionChartInstance } // Pass by reference for chart instance
        );
    }

    async function renderBiannualNCRChart() {
        biannualNCRChartInstance = await createChart(
            'biannualNCRChart',
            '/audits/charts/biannual_ncr_data/',
            (chartData) => ({
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Total NCRs',
                            data: chartData.totalNCRs,
                            backgroundColor: 'rgba(255, 159, 64, 0.8)',
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 1,
                            borderRadius: 5,
                        },
                        {
                            label: 'Open NCRs',
                            data: chartData.openNCRs,
                            backgroundColor: 'rgba(255, 99, 132, 0.8)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1,
                            borderRadius: 5,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Biannual Audits: Total vs. Open NCRs by Lab', font: { size: 18 } },
                        legend: { position: 'top', labels: { boxWidth: 20, padding: 15 } }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Laboratories' }, grid: { display: false } },
                        y: { beginAtZero: true, title: { display: true, text: 'Number of NCRs' }, ticks: { precision: 0 } }
                    },
                    barPercentage: 0.8, categoryPercentage: 0.7,
                }
            }),
            'Biannual Audits: Total vs. Open NCRs by Lab',
            { instance: biannualNCRChartInstance } // Pass by reference
        );
    }

    async function renderHSEInductionCompletion() {
        try {
            const indicatorBox = document.getElementById('hseInductionIndicatorBox');
            if (!indicatorBox) {
                console.error("Parent element 'hseInductionIndicatorBox' not found. Indicator cannot be rendered.");
                return;
            }
            setChartError('hseInductionIndicatorBox', ""); // Clear previous errors

            const response = await fetch('/audits/charts/hse_induction_completion/');
            if (!response.ok) {
                const errorText = await response.text();
                console.error("HTTP Error response text for HSE Induction Completion:", errorText);
                setChartError('hseInductionIndicatorBox', `Error loading data: ${response.status} ${response.statusText}.`, 'HSE Inductions Completion');
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            console.log("HSE Induction Completion data received:", data);

            const percentageElement = document.getElementById('hseInductionPercentage');
            const progressBar = document.getElementById('hseInductionProgressBar');
            const detailsElement = document.getElementById('hseInductionDetails');

            if (percentageElement && progressBar && detailsElement) {
                percentageElement.textContent = `${data.percentage}%`;
                progressBar.style.width = `${data.percentage}%`;
                detailsElement.textContent = `Inductions Completed: ${data.inductions_completed} / Total Employees: ${data.total_employees}`;
                
                // Apply red styling if below 100%
                if (data.percentage < 100) {
                    percentageElement.classList.add('below-100');
                    progressBar.classList.add('below-100');
                } else {
                    percentageElement.classList.remove('below-100');
                    progressBar.classList.remove('below-100');
                }
                
                console.log("HSE Induction Completion indicator updated successfully.");
            } else {
                console.error("One or more HSE Induction Completion indicator elements not found.");
                setChartError('hseInductionIndicatorBox', `Failed to initialize indicator elements.`, 'HSE Inductions Completion');
            }
        } catch (error) {
            console.error('Error rendering HSE Induction Completion:', error);
            if (!document.getElementById('hseInductionIndicatorBox').querySelector('.error-message')) {
                setChartError('hseInductionIndicatorBox', `Failed to load HSE Inductions Completion data.`, 'HSE Inductions Completion');
            }
        }
    }

    async function renderAnnualRefresherCompletion() {
        try {
            const indicatorBox = document.getElementById('annualRefresherIndicatorBox');
            if (!indicatorBox) {
                console.error("Parent element 'annualRefresherIndicatorBox' not found. Indicator cannot be rendered.");
                return;
            }
            setChartError('annualRefresherIndicatorBox', ""); // Clear previous errors

            const response = await fetch('/audits/charts/annual_refresher_completion/');
            if (!response.ok) {
                const errorText = await response.text();
                console.error("HTTP Error response text for Annual Refresher Completion:", errorText);
                setChartError('annualRefresherIndicatorBox', `Error loading data: ${response.status} ${response.statusText}.`, 'Annual Environmental Refresher Completion');
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            console.log("Annual Refresher Completion data received:", data);

            const percentageElement = document.getElementById('annualRefresherPercentage');
            const progressBar = document.getElementById('annualRefresherProgressBar');
            const detailsElement = document.getElementById('annualRefresherDetails');

            if (percentageElement && progressBar && detailsElement) {
                percentageElement.textContent = `${data.percentage}%`;
                progressBar.style.width = `${data.percentage}%`;
                detailsElement.textContent = `Employees Trained: ${data.employees_trained} / Total Employees: ${data.total_employees}`;
                
                // Apply red styling if below 100%
                if (data.percentage < 100) {
                    percentageElement.classList.add('below-100');
                    progressBar.classList.add('below-100');
                } else {
                    percentageElement.classList.remove('below-100');
                    progressBar.classList.remove('below-100');
                }
                
                console.log("Annual Refresher Completion indicator updated successfully.");
            } else {
                console.error("One or more Annual Refresher Completion indicator elements not found.");
                setChartError('annualRefresherIndicatorBox', `Failed to initialize indicator elements.`, 'Annual Environmental Refresher Completion');
            }
        } catch (error) {
            console.error('Error rendering Annual Environmental Refresher Completion:', error);
            if (!document.getElementById('annualRefresherIndicatorBox').querySelector('.error-message')) {
                setChartError('annualRefresherIndicatorBox', `Failed to load Annual Environmental Refresher Completion data.`, 'Annual Environmental Refresher Completion');
            }
        }
    }

    async function renderWasteQuantityPerLabChart() {
         wasteQuantityChartInstance = await createChart(
            'wasteQuantityChart',
            '/audits/charts/waste_quantity_per_lab/',
            (chartData) => ({
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: `Waste Quantity (${chartData.month})`,
                        data: chartData.quantities,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: `Waste Quantity per Lab (${chartData.month})`, font: { size: 18 } },
                        legend: { position: 'top', labels: { boxWidth: 20, padding: 15 } }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Laboratories' }, grid: { display: false } },
                        y: { beginAtZero: true, title: { display: true, text: 'Quantity (Liters)' }, ticks: { precision: 0 } }
                    },
                    barPercentage: 0.8, categoryPercentage: 0.7,
                }
            }),
            'Waste Quantity per Lab (Current Month)',
            { instance: wasteQuantityChartInstance } // Pass by reference
        );
    }

    // NEW: Environmental Incidents Indicator
    async function renderEnvironmentalIncidentsIndicator(locationFilter = '') {
        console.log(`Inside renderEnvironmentalIncidentsIndicator function with filter: ${locationFilter}`);
        const indicatorBox = document.getElementById('environmentalIncidentsIndicatorBox');
        if (!indicatorBox) {
            console.error("Parent element 'environmentalIncidentsIndicatorBox' not found. Indicator cannot be rendered.");
            return;
        }
        setChartError('environmentalIncidentsIndicatorBox', ""); // Clear previous errors

        try {
            let fetchUrl = '/audits/charts/environmental_incidents_data/';
            if (locationFilter) {
                fetchUrl += `?location=${encodeURIComponent(locationFilter)}`;
            }
            console.log(`Fetching data for Environmental Incidents from ${fetchUrl}`); // Corrected: console.log
            const response = await fetch(fetchUrl);
            if (!response.ok) {
                const errorText = await response.text();
                console.error("HTTP Error response text for Environmental Incidents:", errorText);
                setChartError('environmentalIncidentsIndicatorBox', `Error loading data: ${response.status} ${response.statusText}.`, 'Environmental Incidents');
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            console.log("Environmental Incidents data received:", data);

            const incidentsPastMonthElement = document.getElementById('incidentsPastMonth');
            const incidentsTotalElement = document.getElementById('incidentsTotal');
            const locationFilterDropdown = document.getElementById('environmentalIncidentsLocationFilter');

            if (incidentsPastMonthElement && incidentsTotalElement && locationFilterDropdown) {
                incidentsPastMonthElement.textContent = `Incidents (Past Month): ${data.incidents_past_month}`;
                incidentsTotalElement.textContent = `Total Incidents: ${data.total_incidents}`;

                // Populate the dropdown only if it's the initial load or needs recreation
                // Check if dropdown options need to be updated (e.g., first load or options changed)
                const currentOptions = Array.from(locationFilterDropdown.options).map(opt => opt.value);
                const newOptionsValues = data.location_options.map(opt => opt.value);
                const optionsChanged = currentOptions.length !== newOptionsValues.length || !currentOptions.every((val, i) => val === newOptionsValues[i]);

                if (optionsChanged) {
                    locationFilterDropdown.innerHTML = ''; // Clear existing options
                    data.location_options.forEach(option => {
                        const optElement = document.createElement('option');
                        optElement.value = option.value;
                        optElement.textContent = option.text;
                        locationFilterDropdown.appendChild(optElement);
                    });
                }
                // Set the selected value (important if it's not the first load or if filter changed)
                locationFilterDropdown.value = data.selected_location;

                console.log("Environmental Incidents indicator updated successfully.");
            } else {
                console.error("One or more Environmental Incidents indicator elements not found.");
                setChartError('environmentalIncidentsIndicatorBox', `Failed to initialize indicator elements.`, 'Environmental Incidents');
            }
        } catch (error) {
            console.error('Error rendering Environmental Incidents Indicator:', error);
            if (!document.getElementById('environmentalIncidentsIndicatorBox').querySelector('.error-message')) {
                setChartError('environmentalIncidentsIndicatorBox', `Failed to load Environmental Incidents data.`, 'Environmental Incidents');
            }
        }
    }
  </script>
</body>
</html>
